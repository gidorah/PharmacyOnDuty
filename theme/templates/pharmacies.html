{% load static tailwind_tags %}
<!DOCTYPE html>
<html lang="en">

<head>
	<title>Eczanerede</title>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<meta http-equiv="X-UA-Compatible" content="ie=edge" />
	{% tailwind_css %}

	<!-- htmx -->
	<script src="https://unpkg.com/htmx.org"></script>
	<!-- Google Maps Proxy -->
	<script src="/google_maps_proxy"></script>
	<!-- jQuery -->
	<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
	<!-- Hammer.js (CDN) -->
	<script src="https://hammerjs.github.io/dist/hammer.min.js"></script>
</head>

<body class="bg-gray-50 text-gray-900 min-h-screen flex flex-col">



	<!-- Map Section -->
	<main class="flex-1 flex flex-col bg-gray-50">
		<div class="h-14 w-14 m-5 flex items-center bg-primary-100 rounded-l relative z-10 border-b border-neutral-400"
			style="box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);">
			<img src="static/icons/eczane-logo.png" alt="Pharmacy Icon">
		</div>

		<div id="map" class="fixed top-[calc(-14rem)] left-0 right-0 h-[calc(100vh-3rem)] w-full"></div>

		<!-- Pharmacy List Container -->
		<div id="pharmacy-list-container"
			class="p-4 bg-primary-100 shadow-slate-600 shadow-lg rounded-t-3xl relative z-20 border-t border-neutral-400 flex flex-col"
			style="box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.5);">
			<div id="handle" class="w-12 h-1 bg-gray-400 rounded-full mx-auto mb-2"></div>
			<h2 class="text-xl font-bold mb-4 mt-4">En Yakın Eczanerede</h2>
			<!-- Scrollable Area -->
			<div class="flex-1 overflow-y-auto">
				<div id="pharmacy-items" class="space-y-4">
					<!-- Pharmacy items will be dynamically inserted here -->
				</div>
			</div>
		</div>

	</main>

	<!-- Script Logic -->
	<script>
		let map;
		let directionsService;
		let directionsRenderer;
		// Track whether the list is expanded or collapsed
		let isExpanded = false;

		function initMap(center = { lat: 40.7128, lng: -74.0060 }) {
			map = new google.maps.Map(document.getElementById("map"), {
				center: center,
				zoom: 10,
				// Disable all default UI controls
				disableDefaultUI: true,
				// Optional: Disable zoom/pan gestures
				{% comment %} gestureHandling: "none", {% endcomment %}
		// Optional: Disable remaining individual controls
		zoomControl: false,
			mapTypeControl: false,
				scaleControl: false,
					streetViewControl: false,
						rotateControl: false,
							fullscreenControl: false,
			});
		directionsService = new google.maps.DirectionsService();
		directionsRenderer = new google.maps.DirectionsRenderer({ suppressMarkers: true, map: map });
		directionsRenderer.setMap(map);
		}

		function addMarkers(points, userLocation) {
			if (points.length === 0) {
				return;
			}
			let point = points[0];
			const pharmacyIcon = {
				url: '/static/icons/pharmacy-pointer.svg',
				scaledSize: new google.maps.Size(50, 50),
				origin: new google.maps.Point(0, 0),
				anchor: new google.maps.Point(25, 25),
			};
			const marker = new google.maps.Marker({
				position: point.position,
				map: map,
				title: point.title,
				icon: pharmacyIcon,
			});
			const infoWindow = new google.maps.InfoWindow({
				content: `<h3>${point.title}</h3><p>${point.address || ""}</p>`,
			});
			marker.addListener("click", () => {
				infoWindow.open(map, marker);
			});


			const userLocationIcon = {
				url: '/static/icons/user-pointer.svg',
				scaledSize: new google.maps.Size(50, 50),
				origin: new google.maps.Point(0, 0),
				anchor: new google.maps.Point(25, 25),
			};

			// Add a marker for the user's current location
			const userLocationMarker = new google.maps.Marker({
				position: userLocation,
				map: map,
				title: "Konumumu",
				icon: userLocationIcon,
			});
		}

		function updatePharmacyList(pharmacies) {
			const pharmacyItems = $('#pharmacy-items');
			pharmacyItems.empty(); // Clear existing list

			// Insert each pharmacy into the container
			pharmacies.forEach((pharmacy) => {
				const itemHtml = `
          <div class="pharmacy-item bg-primary-100 shadow-sm rounded p-4 flex flex-col md:flex-row items-start md:items-center justify-between">
            <div class="md:flex-grow">
              <p class="text-lg font-semibold mb-1">${pharmacy.title}</p>
              <p class="text-sm text-gray-600">${pharmacy.address} (${pharmacy.distance} metre uzaklıkta)</p>
            </div>
            <div class="mt-2 md:mt-0 flex items-center space-x-3">
              <span class="inline-block text-sm font-medium px-6 py-2 rounded bg-secondary border-2 border-secondary text-white">
                ${pharmacy.status === 'open' ? 'Açık' : 'Nöbetçi'}
              </span>
              <a href="https://www.google.com/maps/dir/?api=1&destination=${pharmacy.position.lat},${pharmacy.position.lng}"
                 class="inline-block px-6 py-2 bg-primary-100 text-secondary rounded border-2 border-secondary text-sm"
                 target="_blank">
                Yol Tarifi
              </a>
            </div>
          </div>
        `;
				pharmacyItems.append(itemHtml);
			});

		}

		function attachHammerSwipeEvents() {
			const containerElement = document.getElementById('pharmacy-list-container');
			const handle = document.getElementById('handle');
			const pharmacyListContainer = $('#pharmacy-list-container');

			let isExpanded = false; // Track whether the list is expanded

			// Function to toggle between expanded and collapsed states
			function toggleBottomSheet() {
				if (isExpanded) {
					pharmacyListContainer.removeClass('expanded').addClass('collapsed');
				} else {
					pharmacyListContainer.removeClass('collapsed').addClass('expanded');
				}
				isExpanded = !isExpanded;
			}

			// Attach click event to handle for toggling
			handle.addEventListener('click', toggleBottomSheet);

			// Attach swipe gestures using Hammer.js
			const hammertime = new Hammer(containerElement);
			hammertime.get('swipe').set({ direction: Hammer.DIRECTION_VERTICAL });

			hammertime.on('swipeup', function () {
				if (!isExpanded) {
					pharmacyListContainer.removeClass('collapsed').addClass('expanded');
					isExpanded = true;
				}
			});

			hammertime.on('swipedown', function () {
				if (isExpanded) {
					pharmacyListContainer.removeClass('expanded').addClass('collapsed');
					isExpanded = false;
				}
			});
		}


		function fetchPharmacyPoints(userLocation = null, city = "eskisehir", callback) {
			$.ajax({
				url: '/get_pharmacy_points',
				method: 'GET',
				dataType: 'json',
				data: {
					"lat": userLocation ? userLocation.lat : '',
					"lng": userLocation ? userLocation.lng : '',
					"city": city,
				},
				success: function (response) {
					callback(response);
				},
				error: function (error) {
					console.error("Error fetching pharmacy points:", error);
				}
			});
		}

		function showDirectionsToNearestMarker(points, userLocation) {
			if (userLocation && points.length > 0) {
				const nearestMarker = points[0];
				const request = {
					origin: new google.maps.LatLng(userLocation.lat, userLocation.lng),
					destination: new google.maps.LatLng(nearestMarker.position.lat, nearestMarker.position.lng),
					travelMode: google.maps.TravelMode.DRIVING,
				};
				directionsService.route(request, (result, status) => {
					if (status === google.maps.DirectionsStatus.OK) {
						directionsRenderer.setDirections(result);
					} else {
						console.error("Directions request failed due to " + status);
						alert("Unable to fetch directions!");
					}
				});
			}
		}

		function getUserLocation(callback) {
			if (navigator.geolocation) {
				navigator.geolocation.getCurrentPosition(
					(position) => {
						const userLocation = {
							lat: position.coords.latitude,
							lng: position.coords.longitude,
						};
						callback(userLocation);
					},
					(error) => {
						console.error("Error getting location:", error);
						callback(null);
					},
					{
						enableHighAccuracy: true,
						timeout: 100000,
						maximumAge: 30000,
					}
				);
			} else {
				console.error("Geolocation is not supported by this browser.");
				callback(null);
			}
		}

		// On page load
		$(document).ready(function () {
			getUserLocation(function (userLocation) {
				if (userLocation) {
					initMap(userLocation);
					fetchPharmacyPoints(userLocation, "eskisehir", function (result) {
						if (result) {
							const points = result.points;
							addMarkers(points, userLocation);
							updatePharmacyList(points);
							attachHammerSwipeEvents();
							showDirectionsToNearestMarker(points, userLocation);
						} else {
							alert("No pharmacy points found.");
						}
					});
				} else {
					alert("Failed to get user location.");
				}
			});
		});
	</script>
</body>

<style>
	#pharmacy-list-container {
		position: fixed;
		bottom: 0;
		left: 0;
		right: 0;
		transition: transform 0.3s ease-in-out;
		transform: translateY(50vh);
		will-change: transform;
		max-height: 80vh;
	}

	#handle {
		cursor: pointer;
	}

	#handle {
		touch-action: drag-y;
	}


	#pharmacy-list-container.expanded {
		transform: translateY(0%);
	}

	#pharmacy-list-container.collapsed {
		transform: translateY(50vh);
	}

	html {
		overflow: hidden;
	}
</style>

</html>