{% load static tailwind_tags %}
<!DOCTYPE html>
<html lang="en">

<head>
	<title>Eczanerede</title>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<meta http-equiv="X-UA-Compatible" content="ie=edge" />
	{% tailwind_css %}

	<!-- htmx -->
	<script src="https://unpkg.com/htmx.org"></script>

	<!-- Google Maps Proxy (ensure this points to your Maps loading script) -->
	<script src="/google_maps_proxy"></script>

	<!-- jQuery -->
	<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>



<body class="bg-gray-50 text-gray-900 min-h-screen flex flex-col">

	<header class="px-6 py-4 flex items-center gap-4 bg-primary-100 relative z-10 shadow-slate-600 shadow-md">
		<div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center shadow-lg relative z-20">
			<img src="static/icons/eczane-logo-circled.svg" alt="Pharmacy Icon" class="w-16 h-16">
		</div>
		<h1 class="text-2xl font-bold text-gray-800">Nearest Pharmacy</h1>
	</header>
	
	<!-- Map Section -->
	<main class="flex-1 flex flex-col bg-gray-50">
		<div id="map" class="flex-1 w-full h-[calc(100vh-200px)]"></div>
		
		<!-- Pharmacy List Container -->
		<div class="p-4 bg-primary-100 shadow-lg rounded-t-xl mt-[-2rem] relative z-20">
			<h2 class="text-xl font-semibold mb-4">Nearest Pharmacies</h2>
			<div id="pharmacy-items" class="space-y-4">
				<!-- Pharmacy items will be dynamically inserted here by updatePharmacyList -->
			</div>
		</div>
	</main>

	<!-- Your existing scripts and logic -->
	<script>
		$(document).ready(function () {
			function fetchPharmacyPoints(userLocation = null, city = "eskisehir", callback) {
				$.ajax({
					url: '/get_pharmacy_points',
					method: 'GET',
					dataType: 'json',
					data: {
						"lat": userLocation.lat,
						"lng": userLocation.lng,
						"city": city,
					},
					success: function (response) {
						callback(response);
					},
					error: function (error) {
						console.error("Error fetching pharmacy points:", error);
					}
				});
			}

			function updatePharmacyList(pharmacies) {
				const pharmacyItems = $('#pharmacy-items');
				pharmacyItems.empty(); // Clear existing list

				// Show top 5 or however many you prefer
				pharmacies.slice(0, 5).forEach(pharmacy => {
					pharmacyItems.append(`
					  <div class="bg-white shadow rounded p-4 flex flex-col md:flex-row items-start md:items-center justify-between">
						  <div class="md:flex-grow">
							  <p class="text-lg font-semibold mb-1">${pharmacy.title}</p>
							  <p class="text-sm text-gray-600">${pharmacy.address} (${pharmacy.distance}m away)</p>
						  </div>
						  <div class="mt-2 md:mt-0 flex items-center space-x-3">
							  <span class="inline-block text-sm font-medium px-3 py-1 rounded
								${pharmacy.status === 'open'
							? 'bg-green-100 text-green-800'
							: 'bg-red-100 text-red-800'}">
								  ${pharmacy.status}
							  </span>
							  <a href="https://www.google.com/maps/dir/?api=1&destination=${pharmacy.position.lat},${pharmacy.position.lng}"
								 class="inline-block px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 text-sm"
								 target="_blank">
								Directions
							  </a>
						  </div>
					  </div>
				  `);
				});
			}

			getUserLocation(function (userLocation) {
				if (userLocation) {
					initMap(userLocation);
					fetchPharmacyPoints(userLocation, "eskisehir", function (result) {
						if (result) {
							const points = result['points'];
							addMarkers(points);
							updatePharmacyList(points);
							showDirectionsToNearestMarker(points, userLocation);
						} else {
							alert("No pharmacy points found.");
						}
					});
				} else {
					alert("Failed to get user location.");
				}
			});
		});

		let map;
		let directionsService;
		let directionsRenderer;

		function initMap(center = { lat: 40.7128, lng: -74.0060 }) {
			map = new google.maps.Map(document.getElementById("map"), {
				center: center,
				zoom: 10,
			});

			directionsService = new google.maps.DirectionsService();
			directionsRenderer = new google.maps.DirectionsRenderer();
			directionsRenderer.setMap(map);
		}

		function addMarkers(points) {
			points.forEach((point) => {
				const marker = new google.maps.Marker({
					position: point.position,
					map: map,
					title: point.title,
				});

				const infoWindow = new google.maps.InfoWindow({
					content: `<h3>${point.title}</h3><p>${point.description || ""}</p>`,
				});

				marker.addListener("click", () => {
					infoWindow.open(map, marker);
				});
			});
		}

		function getUserLocation(callback) {
			if (navigator.geolocation) {
				navigator.geolocation.getCurrentPosition(
					(position) => {
						const userLocation = {
							lat: position.coords.latitude,
							lng: position.coords.longitude,
						};
						callback(userLocation);
					},
					(error) => {
						console.error("Error getting location:", error);
						callback(null);
					},
					{
						enableHighAccuracy: true,
						timeout: 100000,
						maximumAge: 30000,
					}
				);
			} else {
				console.error("Geolocation is not supported by this browser.");
				callback(null);
			}
		}

		function showDirectionsToNearestMarker(points, userLocation) {
			if (userLocation) {
				const nearestMarker = points[0];
				if (nearestMarker) {
					const request = {
						origin: new google.maps.LatLng(userLocation.lat, userLocation.lng),
						destination: new google.maps.LatLng(nearestMarker.position.lat, nearestMarker.position.lng),
						travelMode: google.maps.TravelMode.DRIVING,
					};

					directionsService.route(request, (result, status) => {
						if (status === google.maps.DirectionsStatus.OK) {
							directionsRenderer.setDirections(result);
						} else {
							console.error("Directions request failed due to " + status);
							alert("Unable to fetch directions!");
						}
					});
				}
			}
		}
	</script>

</body>

</html>