<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HTMX Google Maps</title>
  <script src="https://unpkg.com/htmx.org"></script>
  <script src="/google_maps_proxy"></script>
  <style>
      #map {
          height: 500px;
          width: 100%;
      }
  </style>
</head>
<body>
<h1>Google Maps with HTMX</h1>
<div id="mapDiv" hx-get="/load_map_data" hx-trigger="load" hidden=""></div>
<div id="map"></div>

<script>
    let map;
    let directionsService;
    let directionsRenderer;

    function initMap(center = { lat: 40.7128, lng: -74.0060 }) {
        // Initialize the map
        map = new google.maps.Map(document.getElementById("map"), {
            center: center,
            zoom: 10, // Default zoom
        });

        // Initialize DirectionsService and DirectionsRenderer
        directionsService = new google.maps.DirectionsService();
        directionsRenderer = new google.maps.DirectionsRenderer();
        directionsRenderer.setMap(map); // Attach the directions renderer to the map
    }

    function addMarkers(points) {
        points.forEach((point) => {
            const marker = new google.maps.Marker({
                position: point.position,
                map: map,
                title: point.title,
            });

            const infoWindow = new google.maps.InfoWindow({
                content: `<h3>${point.title}</h3><p>${point.description || ""}</p>`,
            });

            marker.addListener("click", () => {
                infoWindow.open(map, marker);
            });
        });
    }

    function getUserLocation(callback) {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const userLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude,
                    };
                    callback(userLocation);
                },
                (error) => {
                    console.error("Error getting location:", error);
                    callback(null);
                },
                {
                    enableHighAccuracy: true,  // Better accuracy but higher battery usage
                    timeout: 10000,           // Maximum time to wait for location
                    maximumAge: 30000         // Use a cached position if available
                }
            );
        } else {
            console.error("Geolocation is not supported by this browser.");
            callback(null);
        }
    }

    function calculateNearestMarker(userLocation, points) {
        let nearestMarker = null;
        let shortestDistance = Infinity;

        points.forEach((point) => {
            const distance = google.maps.geometry.spherical.computeDistanceBetween(
                new google.maps.LatLng(userLocation.lat, userLocation.lng),
                new google.maps.LatLng(point.position.lat, point.position.lng)
            );

            if (distance < shortestDistance) {
                shortestDistance = distance;
                nearestMarker = point;
            }
        });

        return nearestMarker;
    }

    function showDirectionsToNearestMarker(points) {
        getUserLocation((userLocation) => {
            if (userLocation) {
                const nearestMarker = calculateNearestMarker(userLocation, points);

                if (nearestMarker) {
                    const request = {
                        origin: new google.maps.LatLng(userLocation.lat, userLocation.lng),
                        destination: new google.maps.LatLng(nearestMarker.position.lat, nearestMarker.position.lng),
                        travelMode: google.maps.TravelMode.DRIVING, // You can change this to WALKING, BICYCLING, etc.
                    };

                    // Request directions from the DirectionsService
                    directionsService.route(request, (result, status) => {
                        if (status === google.maps.DirectionsStatus.OK) {
                            directionsRenderer.setDirections(result);
                        } else {
                            console.error("Directions request failed due to " + status);
                            alert("Unable to fetch directions!");
                        }
                    });

                    // Optional: Add a marker for the user's location
                    new google.maps.Marker({
                        position: userLocation,
                        map: map,
                        title: "You are here",
                        icon: {
                            url: "http://maps.google.com/mapfiles/ms/icons/blue-dot.png",
                        },
                    });

                    // Optionally zoom to fit the route
                    map.setCenter(userLocation);
                } else {
                    alert("No markers found to calculate directions.");
                }
            } else {
                alert("Could not detect your location. Please enable location services.");
            }
        });
    }

    // Main map handler
    document.addEventListener("htmx:afterOnLoad", (event) => {
        if (event.detail.elt.id === "mapDiv") {
            const data = JSON.parse(event.detail.xhr.responseText);
            const { center, points } = data;

            if (!map) {
                initMap(center);
            }
            addMarkers(points);

            // Automatically show directions to the nearest marker when the user's location is detected
            showDirectionsToNearestMarker(points);
        }
    });
</script>

</body>
</html>