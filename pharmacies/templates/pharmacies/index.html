<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="/static/favicon.ico" type="image/x-icon">
  <title>Pharmacy On Duty</title>
  <script src="https://unpkg.com/htmx.org"></script>
  <script src="/google_maps_proxy"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <style>
      body {
          font-family: Arial, sans-serif;
          margin: 0;
          padding: 0;
          background-color: #f9f9f9;
      }

      #map {
          height: 60vh;
          width: 100%;
      }

      .pharmacy-list {
          padding: 15px;
          background-color: #fff;
          box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.1);
      }

      .pharmacy-list h2 {
          font-size: 18px;
          margin-bottom: 10px;
      }

      .pharmacy-item {
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 10px;
          margin-bottom: 10px;
          border: 1px solid #ddd;
          border-radius: 5px;
          background-color: #fefefe;
      }

      .pharmacy-details {
          flex-grow: 1;
      }

      .pharmacy-name {
          font-weight: bold;
          margin: 0;
      }

      .pharmacy-address {
          font-size: 14px;
          color: #555;
      }

      .status {
          font-size: 14px;
          padding: 5px 10px;
          border-radius: 3px;
      }

      .status.open {
          background-color: #d4edda;
          color: #155724;
      }

      .status.closed {
          background-color: #f8d7da;
          color: #721c24;
      }

      .directions {
          padding: 5px 10px;
          background-color: #007bff;
          color: #fff;
          text-decoration: none;
          border-radius: 3px;
          font-size: 14px;
      }

      .directions:hover {
          background-color: #0056b3;
      }
  </style>
</head>
<body>
<h1>En Yakın Açık Eczane</h1>
<div id="map"></div>

<div class="pharmacy-list">
  <h2>Nearest Pharmacies</h2>
  <div id="pharmacy-items">
    <!-- Pharmacy items will be dynamically added here -->
  </div>
</div>

<script>
    $(document).ready(function () {
        function fetchPharmacyPoints(userLocation = null, city = "eskisehir", callback) {
            $.ajax({
                url: '/get_pharmacy_points',
                method: 'GET',
                dataType: 'json',
                data: {
                    "lat": userLocation.lat,
                    "lng": userLocation.lng,
                    "city": city,
                },
                success: function (response) {
                    callback(response);
                },
                error: function (error) {
                    console.error("Error fetching pharmacy points:", error);
                }
            });
        }

        function updatePharmacyList(pharmacies) {
            const pharmacyItems = $('#pharmacy-items');
            pharmacyItems.empty(); // Clear existing list
            pharmacies.slice(0, 5).forEach(pharmacy => {
                pharmacyItems.append(`
                    <div class="pharmacy-item">
                        <div class="pharmacy-details">
                            <p class="pharmacy-name">${pharmacy.title}</p>
                            <p class="pharmacy-address">${pharmacy.address} (${pharmacy.distance}m away)</p>
                        </div>
                        <span class="status ${pharmacy.status}">
                            ${pharmacy.status}
                        </span>
                        <a href="https://www.google.com/maps/dir/?api=1&destination=${pharmacy.position.lat},${pharmacy.position.lng}" class="directions" target="_blank">Directions</a>
                    </div>
                `);
            });
        }

        getUserLocation(function (userLocation) {
            if (userLocation) {
                initMap(userLocation);
                fetchPharmacyPoints(userLocation, "eskisehir", function (result) {
                    if (result) {
                        const points = result['points'];
                        addMarkers(points);
                        updatePharmacyList(points);
                        showDirectionsToNearestMarker(points, userLocation);
                    } else {
                        alert("No pharmacy points found.");
                    }
                });
            } else {
                alert("Failed to get user location.");
            }
        });
    });

    let map;
    let directionsService;
    let directionsRenderer;

    function initMap(center = { lat: 40.7128, lng: -74.0060 }) {
        map = new google.maps.Map(document.getElementById("map"), {
            center: center,
            zoom: 10,
        });

        directionsService = new google.maps.DirectionsService();
        directionsRenderer = new google.maps.DirectionsRenderer();
        directionsRenderer.setMap(map);
    }

    function addMarkers(points) {
        points.forEach((point) => {
            const marker = new google.maps.Marker({
                position: point.position,
                map: map,
                title: point.title,
            });

            const infoWindow = new google.maps.InfoWindow({
                content: `<h3>${point.title}</h3><p>${point.description || ""}</p>`,
            });

            marker.addListener("click", () => {
                infoWindow.open(map, marker);
            });
        });
    }

    function getUserLocation(callback) {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const userLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude,
                    };
                    callback(userLocation);
                },
                (error) => {
                    console.error("Error getting location:", error);
                    callback(null);
                },
                {
                    enableHighAccuracy: true,
                    timeout: 100000,
                    maximumAge: 30000,
                }
            );
        } else {
            console.error("Geolocation is not supported by this browser.");
            callback(null);
        }
    }

    function showDirectionsToNearestMarker(points, userLocation) {
        if (userLocation) {
            const nearestMarker = points[0];
            if (nearestMarker) {
                const request = {
                    origin: new google.maps.LatLng(userLocation.lat, userLocation.lng),
                    destination: new google.maps.LatLng(nearestMarker.position.lat, nearestMarker.position.lng),
                    travelMode: google.maps.TravelMode.DRIVING,
                };

                directionsService.route(request, (result, status) => {
                    if (status === google.maps.DirectionsStatus.OK) {
                        directionsRenderer.setDirections(result);
                    } else {
                        console.error("Directions request failed due to " + status);
                        alert("Unable to fetch directions!");
                    }
                });
            }
        }
    }
</script>
</body>
</html>